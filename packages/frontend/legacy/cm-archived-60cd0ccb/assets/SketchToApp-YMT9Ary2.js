import{r as s,j as e}from"./index-BZk6po0a.js";import{a as y,b as z}from"./apiBase-CiMW8Nzu.js";const I="w-full rounded-xl border border-slate-300 px-3 py-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500";function K({defaultName:a="",defaultPages:o="Home,Dashboard,Chat",defaultDesc:r="",baseUrl:c}){const[u,N]=s.useState(a),[l,f]=s.useState(o),[i,S]=s.useState(r),v=s.useMemo(()=>{if(c)return c;try{const d=window.location.hostname;if(d.includes("cognomega.com")&&d.startsWith("builder."))return`${window.location.origin}`}catch{}return"https://builder.cognomega.com"},[c]),g=()=>{const d=`${v}/?name=${encodeURIComponent(u||"MyApp")}&pages=${encodeURIComponent(l||"Home,Dashboard,Chat")}&desc=${encodeURIComponent(i||"")}&autogen=1`;window.open(d,"_blank","noopener")};return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"Realtime Builder"}),e.jsx("span",{className:"text-xs text-slate-500",children:"Opens in a new tab"})]}),e.jsxs("div",{className:"grid gap-3 md:grid-cols-3",children:[e.jsx("input",{className:I,placeholder:"Sketch/App name (e.g. Sales Dashboard)",value:u,onChange:d=>N(d.target.value)}),e.jsx("input",{className:I,placeholder:"Pages (comma-separated)",value:l,onChange:d=>f(d.target.value)}),e.jsx("button",{onClick:g,className:"rounded-xl bg-black px-4 py-2 text-white hover:bg-zinc-800",children:"Launch in Builder"})]}),e.jsx("textarea",{className:I,placeholder:"Description (optional)",rows:2,value:i,onChange:d=>S(d.target.value)})]})}const O=1e3,L=12e4,G="guest_token",M="jwt",B="cog_auth_jwt",W=()=>Math.floor(Date.now()/1e3);function H(){try{const a=localStorage.getItem(G);if(a&&a.trim())return a;const o=localStorage.getItem(M);if(o&&o.trim())return o;const r=localStorage.getItem(B);if(r)try{const c=JSON.parse(r);if(c&&typeof c.token=="string"&&c.token.trim())return c.token}catch{}}catch{}return null}function V(a,o){try{localStorage.setItem(G,a),localStorage.setItem(M,a),localStorage.setItem(B,JSON.stringify({token:a,exp:o}))}catch{}}async function q(){const a=[{url:`${y}/auth/guest`,method:"GET"},{url:`${y}/auth/guest`,method:"POST"},{url:`${y}/api/auth/guest`,method:"GET"},{url:`${y}/api/auth/guest`,method:"POST"}];let o=null;for(const r of a)try{const c={method:r.method,headers:{Accept:"application/json"}};r.method==="POST"&&(c.headers={...c.headers,"Content-Type":"application/json"},c.body="{}");const u=await fetch(r.url,c);if(!u.ok){o=new Error(`${u.status} ${u.statusText}`);continue}const l=(u.headers.get("content-type")||"").toLowerCase().includes("application/json")?await u.json():await u.text(),f=(typeof l=="string"?l:l?.token||l?.jwt||l?.guest_token)||null,i=typeof l=="object"?Number(l?.exp):void 0;if(f&&String(f).trim())return V(String(f).trim(),i||W()+3600),String(f).trim()}catch(c){o=c}return console.debug("mintGuestToken failed",o),null}async function k(a=!1){if(!a){const o=H();if(o)return o}return await q()}function T(){const o={Accept:"application/json",...z()};if(!("Authorization"in o)){const r=H();r&&(o.Authorization=`Bearer ${r}`)}for(const r of Object.keys(o))r.toLowerCase()==="content-type"&&delete o[r];return o}const _="w-full rounded-xl border border-slate-300 px-3 py-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500",J="rounded-2xl border border-slate-200 bg-white shadow-sm";function Z(){const[a,o]=s.useState(null),[r,c]=s.useState(""),[u,N]=s.useState(!1),[l,f]=s.useState(null),[i,S]=s.useState(null),[v,g]=s.useState(null),[d,x]=s.useState(null),b=s.useRef(null),C=s.useRef(null),E=s.useRef(0);s.useEffect(()=>{k()},[]);const P=s.useCallback(async(n,m)=>{await k();const t=await fetch(n,{headers:T(),signal:m}),h=t.headers.get("content-type")||"";if(!t.ok)throw new Error(`${t.status} ${t.statusText}`);if(!h.toLowerCase().includes("application/json")){const p=await t.text();throw new Error(`Unexpected content-type: ${h} | ${p.slice(0,160)}`)}return t.json()},[]),j=s.useCallback(()=>{if(b.current)try{b.current.abort()}catch{}b.current=null,C.current&&(window.clearTimeout(C.current),C.current=null)},[]),D=s.useCallback(n=>{j(),b.current=new AbortController,E.current=Date.now();const m=async()=>{try{if(Date.now()-E.current>L){x(null),g("Timed out waiting for job to finish."),j();return}const h=(await P(`${y}/api/jobs/${encodeURIComponent(n)}`,b.current?.signal))?.job??{},p={id:h.id,status:String(h.status||""),progress:h.progress};if(S(p),p.status==="done"){x("Job finished. You can download the result."),j();return}if(p.status==="error"||p.status==="failed"){g("Job failed."),j();return}C.current=window.setTimeout(m,O)}catch(t){if(b.current?.signal.aborted)return;Date.now()-E.current<=L?(x("Reconnecting…"),C.current=window.setTimeout(m,O)):(x(null),g(t?.message||"Poll failed"),j())}};m()},[P,j]),U=s.useCallback(async n=>{N(!0),g(null),x("Uploading…"),S(null),f(null);const m=async()=>{await k();const t=new FormData;return t.append("file",n),t.append("prompt",r),await fetch(`${y}/v1/files/upload`,{method:"POST",headers:T(),body:t})};try{let t=await m();(t.status===401||t.status===403)&&(await k(!0),t=await m());const h=t.headers.get("content-type")||"";if(!h.toLowerCase().includes("application/json")){const w=await t.text();throw new Error(`Unexpected content-type: ${h} | ${w.slice(0,160)}`)}const p=await t.json();if(!t.ok||p.error){const w=p.error?String(p.error):`${t.status} ${t.statusText}`;throw new Error(w)}const $=p;f($.job_id),x("Uploaded. Processing…"),D($.job_id)}catch(t){g(t?.message||"Upload failed")}finally{N(!1)}},[r,D]),F=s.useCallback(n=>{g(null),x(null),S(null),f(null);const m=n.target.files&&n.target.files[0]?n.target.files[0]:null;o(m),m&&U(m)},[U]),Y=s.useCallback(async()=>{if(l){g(null),x("Preparing download…");try{await k();let n=await fetch(`${y}/api/jobs/${encodeURIComponent(l)}/download`,{method:"GET",headers:T(),signal:b.current?.signal});if((n.status===401||n.status===403)&&(await k(!0),n=await fetch(`${y}/api/jobs/${encodeURIComponent(l)}/download`,{method:"GET",headers:T(),signal:b.current?.signal})),!n.ok)throw new Error(`${n.status} ${n.statusText}`);const h=(n.headers.get("content-disposition")||"").match(/filename="([^"]+)"/i)?.[1]||`job_${l}.bin`,p=await n.blob(),$=URL.createObjectURL(p),w=document.createElement("a");w.href=$,w.download=h,document.body.appendChild(w),w.click(),w.remove(),URL.revokeObjectURL($),x("Downloaded.")}catch(n){b.current?.signal.aborted||g(n?.message||"Download failed")}}},[l]);s.useEffect(()=>()=>j(),[j]);const R=i?.status==="done",A=s.useMemo(()=>!!a&&!u,[a,u]);return e.jsxs("div",{className:"min-h-screen bg-slate-50",children:[e.jsx("header",{className:"border-b bg-white",children:e.jsx("div",{className:"max-w-6xl mx-auto px-6 py-4",children:e.jsx("div",{className:"text-xl font-semibold tracking-tight",children:"Cognomega"})})}),e.jsxs("main",{className:"max-w-4xl mx-auto p-6 space-y-6",children:[e.jsxs("div",{className:`${J} p-6`,children:[e.jsxs("div",{className:"flex items-start justify-between gap-4",children:[e.jsx("h1",{className:"text-2xl font-semibold",children:"Sketch → App"}),i?.status&&e.jsxs("span",{className:`inline-flex items-center rounded-full px-2.5 py-1 text-xs font-medium ${R?"bg-green-100 text-green-700":i?.status==="error"||i?.status==="failed"?"bg-rose-100 text-rose-700":"bg-slate-100 text-slate-600"}`,children:[i.status,typeof i.progress<"u"&&i.progress!==null&&` • ${String(i.progress)}%`]})]}),e.jsxs("div",{className:"mt-6 grid gap-5",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Sketch file"}),e.jsx("input",{type:"file",accept:".png,.jpg,.jpeg,.webp,.pdf,.gif",onChange:F,className:_}),e.jsx("p",{className:"mt-1 text-xs text-slate-500",children:"Upload starts automatically once you pick a file."})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium mb-1",children:["Prompt ",e.jsx("span",{className:"text-slate-400",children:"(optional)"})]}),e.jsx("textarea",{value:r,onChange:n=>c(n.target.value),rows:3,placeholder:"Add any notes about the UI or behavior…",className:_})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{disabled:!A,onClick:()=>a&&U(a),className:`rounded-xl px-4 py-2 text-white transition ${A?"bg-indigo-600 hover:bg-indigo-700":"bg-slate-400 cursor-not-allowed"}`,children:u?"Uploading…":"Upload"}),l&&e.jsxs("span",{className:"text-sm text-slate-600",children:["Job: ",e.jsx("code",{className:"text-xs",children:l})]})]}),(i||v||d)&&e.jsxs("div",{className:"rounded-xl border border-slate-200 bg-slate-50 p-4 text-sm space-y-2",children:[d&&e.jsx("div",{className:"text-slate-700",children:d}),v&&e.jsxs("div",{className:"text-rose-600",children:["Error: ",v]}),R&&e.jsx("div",{className:"pt-2",children:e.jsx("button",{onClick:Y,className:"rounded-xl bg-emerald-600 px-3 py-2 text-white hover:bg-emerald-700",children:"Download result"})})]})]})]}),e.jsx("div",{className:`${J} p-6`,children:e.jsx(K,{defaultName:"Sketch Prototype",defaultPages:"Home,Dashboard,Chat",defaultDesc:r||"From Sketch to App"})})]})]})}export{Z as default};
